name: Deploy

on:
  push:
    branches:
      - main

env:
  PNPM_VERSION: 9.0.0

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-api:
    name: Build API image and update ECS
    runs-on: ubuntu-latest
    environment: actions ci
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      ECS_SERVICE: ${{ vars.ECS_SERVICE }}
      ECS_TASK_FAMILY: ${{ vars.ECS_TASK_FAMILY }}
      ECS_CONTAINER_NAME: ${{ vars.ECS_CONTAINER_NAME }}
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure required variables exist
        run: |
          set -euo pipefail
          missing=()
          for var in AWS_REGION AWS_ACCOUNT_ID ECR_REPOSITORY ECS_CLUSTER ECS_SERVICE ECS_TASK_FAMILY ECS_CONTAINER_NAME; do
            if [ -z "${!var:-}" ]; then
              missing+=("$var")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required environment variables: ${missing[*]}" >&2
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Type-check API
        run: pnpm --filter api... run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        id: build-image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Update ECS service
        id: ecs-deploy
        env:
          IMAGE_URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          aws ecs describe-task-definition \
            --task-definition "$ECS_TASK_FAMILY" \
            --query 'taskDefinition' \
            > task-definition.json

          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .deregisteredAt, .enableFaultInjection)' \
            task-definition.json > task-definition-slim.json

          jq --arg IMAGE_URI "$IMAGE_URI" --arg CONTAINER_NAME "$ECS_CONTAINER_NAME" \
            '.containerDefinitions |= map(if .name == $CONTAINER_NAME then .image = $IMAGE_URI else . end)' \
            task-definition-slim.json > task-definition-updated.json

          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition-updated.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "$TASK_DEF_ARN" \
            --force-new-deployment

  deploy-app:
    name: Upload React app to S3
    runs-on: ubuntu-latest
    environment: actions ci
    needs: deploy-api
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      S3_BUCKET: ${{ vars.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure required variables exist
        run: |
          set -euo pipefail
          missing=()
          for var in AWS_REGION S3_BUCKET; do
            if [ -z "${!var:-}" ]; then
              missing+=("$var")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required environment variables: ${missing[*]}" >&2
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Build React app
        run: pnpm --filter app... run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync assets to S3
        run: aws s3 sync apps/app/dist s3://$S3_BUCKET --delete

      - name: Invalidate CloudFront cache
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths '/*'
